@model ST10448895_CMCS_PROG.Models.ViewModels.ClaimSubmissionViewModel

@{
    ViewData["Title"] = "Submit Claim";

    var lecturerId = Context.Session.GetInt32("UserId") ?? 0;
    var db = Context.RequestServices.GetRequiredService<ST10448895_CMCS_PROG.Data.ApplicationDbContext>();

    var moduleAssignments = (
        from lm in db.LecturerModules
        join m in db.Modules on lm.ModuleId equals m.Id
        where lm.LecturerId == lecturerId
        select new
        {
            m.Id,
            m.ModuleCode,
            m.ModuleName,
            lm.HourlyRate
        }
    ).ToList();
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-7">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">New Claim</h5>
                </div>
                <div class="card-body">

                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger">@TempData["Error"]</div>
                    }

                    @if (!moduleAssignments.Any())
                    {
                        <div class="alert alert-warning">
                            <strong>No Modules Assigned</strong>
                            <p>Please contact HR to assign modules and set hourly rates.</p>
                            <a asp-action="Index" class="btn btn-secondary mt-2">Back</a>
                        </div>
                    }
                    else
                    {
                        <form asp-action="Submit" method="post" enctype="multipart/form-data">
                            @Html.AntiForgeryToken()

                            <!-- Module -->
                            <div class="mb-3">
                                <label class="form-label">Module *</label>
                                <select name="moduleId" id="moduleSelect" class="form-select" required>
                                    <option value="">Select module</option>
                                    @foreach (var m in moduleAssignments)
                                    {
                                        <option value="@m.Id"
                                                data-rate="@m.HourlyRate"
                                                data-name="@m.ModuleName"
                                                data-code="@m.ModuleCode">
                                            @m.ModuleCode - @m.ModuleName 
                                        </option>
                                    }
                                </select>
                            </div>

                            <div id="moduleInfo" class="alert alert-light d-none">
                                <div><strong>Module:</strong> <span id="modName"></span></div>
                                <div><strong>Rate:</strong> <span id="modRate" class="text-success"></span></div>
                            </div>

                            <!-- Hours -->
                            <div class="mb-3">
                                <label class="form-label">Hours Worked *</label>
                                <input type="number"
                                       name="Claim.HoursWorked"
                                       id="hoursInput"
                                       class="form-control"
                                       min="1"
                                       max="1000"
                                       required />
                            </div>

                            <input type="hidden" name="Claim.HourlyRate" id="rateInput" />

                            <!-- Total -->
                            <div class="mb-3">
                                <label class="form-label">Total Amount</label>
                                <input id="totalAmount"
                                       class="form-control text-center fw-bold fs-4"
                                       readonly />
                            </div>

                            <!-- Description -->
                            <div class="mb-3">
                                <label class="form-label">Description *</label>
                                <textarea name="Claim.Description" class="form-control" rows="3" required></textarea>
                            </div>

                            <!-- Files -->
                            <div class="mb-3">
                                <label class="form-label">Supporting Documents</label>
                                <input type="file" name="Documents" id="fileInput" class="form-control" multiple accept=".pdf,.docx,.xlsx" />
                                <small class="text-muted">PDF/Word/Excel only >Max 5MB each</small>
                                <div id="fileList" class="mt-2"></div>
                            </div>

                            <!-- Buttons -->
                            <div class="d-flex justify-content-between mt-4">
                                <a asp-action="Index" class="btn btn-secondary">Cancel</a>
                                <button class="btn btn-success" id="submitBtn" disabled>Submit Claim</button>
                            </div>
                        </form>

                        
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const moduleSelect = document.getElementById("moduleSelect");
        const hoursInput = document.getElementById("hoursInput");
        const rateInput = document.getElementById("rateInput");
        const totalInput = document.getElementById("totalAmount");
        const submitBtn = document.getElementById("submitBtn");

        const infoBox = document.getElementById("moduleInfo");
        const nameSpan = document.getElementById("modName");
        const rateSpan = document.getElementById("modRate");

        moduleSelect.addEventListener("change", () => {
            const opt = moduleSelect.options[moduleSelect.selectedIndex];
            const rate = opt.dataset.rate;
            const name = opt.dataset.name;
            const code = opt.dataset.code;

            if (rate) {
                rateInput.value = rate;
                nameSpan.textContent = `${code} - ${name}`;
                rateSpan.textContent = `R${parseFloat(rate).toFixed(2)} / hour`;
                infoBox.classList.remove("d-none");
                updateTotal();
            } else {
                infoBox.classList.add("d-none");
                totalInput.value = "";
            }
            validate();
        });

        hoursInput.addEventListener("input", () => {
            updateTotal();
            validate();
        });

        function updateTotal() {
            const hrs = parseFloat(hoursInput.value) || 0;
            const rate = parseFloat(rateInput.value) || 0;
            totalInput.value = hrs && rate ? "R " + (hrs * rate).toFixed(2) : "";
        }

        function validate() {
            submitBtn.disabled = !(moduleSelect.value && hoursInput.value > 0);
        }

        // file display
        document.getElementById("fileInput").addEventListener("change", function () {
            const fileList = document.getElementById("fileList");
            fileList.innerHTML = "";
            if (this.files.length === 0) return;

            const ul = document.createElement("ul");
            ul.className = "list-group small";

            Array.from(this.files).forEach(f => {
                const li = document.createElement("li");
                li.className = "list-group-item d-flex justify-content-between";
                const size = (f.size / 1024 / 1024).toFixed(2);
                li.innerHTML = `<span>${f.name}</span><span class="badge ${size > 5 ? "bg-danger" : "bg-success"}">${size} MB</span>`;
                ul.appendChild(li);
            });

            fileList.appendChild(ul);
        });
    });
</script>
