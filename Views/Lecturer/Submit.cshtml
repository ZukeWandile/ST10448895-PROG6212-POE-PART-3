@model ST10448895_CMCS_PROG.Models.ViewModels.ClaimSubmissionViewModel

@{
    ViewData["Title"] = "Submit Claim";

    // Get lecturer's assigned modules with rates
    var lecturerId = Context.Session.GetInt32("UserId") ?? 0;
    var dbContext = Context.RequestServices.GetRequiredService<ST10448895_CMCS_PROG.Data.ApplicationDbContext>();
    var assignments = dbContext.LecturerModules
        .Where(lm => lm.LecturerId == lecturerId)
        .Select(lm => new
        {
            lm.Id,
            lm.ModuleId,
            lm.HourlyRate,
            ModuleCode = dbContext.Modules.Where(m => m.Id == lm.ModuleId).Select(m => m.ModuleCode).FirstOrDefault(),
            ModuleName = dbContext.Modules.Where(m => m.Id == lm.ModuleId).Select(m => m.ModuleName).FirstOrDefault()
        })
        .ToList();
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">Submit New Claim</h4>
                </div>
                <div class="card-body">
                    @if (!assignments.Any())
                    {
                        <div class="alert alert-warning">
                            <h5><i class="bi bi-exclamation-triangle"></i> No Modules Assigned</h5>
                            <p>You don't have any modules assigned yet. Please contact HR to assign modules and set your hourly rates.</p>
                            <a asp-action="Index" class="btn btn-secondary">Back to Claims</a>
                        </div>
                    }
                    else
                    {
                        <form asp-action="Submit" method="post" enctype="multipart/form-data">
                            @Html.AntiForgeryToken()

                            <!-- Module Selection (with HR-set rates) -->
                            <div class="mb-3">
                                <label class="form-label">Select Module</label>
                                <select id="moduleSelect" name="moduleId" class="form-select" required>
                                    <option value="">-- Choose the module you taught --</option>
                                    @foreach (var assignment in assignments)
                                    {
                                        <option value="@assignment.ModuleId"
                                                data-rate="@assignment.HourlyRate">
                                            @assignment.ModuleCode - @assignment.ModuleName (Rate: @assignment.HourlyRate.ToString("C")/hr)
                                        </option>
                                    }
                                </select>
                                <small class="form-text text-muted">Your hourly rate is set by HR for each module</small>
                            </div>

                            <!-- Hours Worked -->
                            <div class="mb-3">
                                <label asp-for="Claim.HoursWorked" class="form-label">Hours Worked</label>
                                <input asp-for="Claim.HoursWorked"
                                       id="hoursInput"
                                       class="form-control"
                                       type="number"
                                       min="1"
                                       max="1000"
                                       required>
                                <span asp-validation-for="Claim.HoursWorked" class="text-danger"></span>
                            </div>

                            <!-- Hourly Rate (Read-Only, set by module selection) -->
                            <div class="mb-3">
                                <label asp-for="Claim.HourlyRate" class="form-label">Hourly Rate (Set by HR)</label>
                                <input asp-for="Claim.HourlyRate"
                                       id="rateInput"
                                       class="form-control"
                                       type="number"
                                       step="0.01"
                                       readonly
                                       style="background-color: #f8f9fa;">
                                <small class="form-text text-muted">This rate is assigned by HR and cannot be changed</small>
                            </div>

                            <!-- Total Amount (Auto-calculated) -->
                            <div class="mb-3">
                                <label class="form-label">Total Claim Amount</label>
                                <input id="totalAmount"
                                       class="form-control form-control-lg"
                                       readonly
                                       style="font-weight: bold; font-size: 1.5em; color: #28a745;">
                            </div>

                            <!-- Description -->
                            <div class="mb-3">
                                <label asp-for="Claim.Description" class="form-label">Description</label>
                                <textarea asp-for="Claim.Description"
                                          class="form-control"
                                          rows="4"
                                          placeholder="Describe the work performed (e.g., lectures, tutorials, marking)"
                                          required></textarea>
                                <span asp-validation-for="Claim.Description" class="text-danger"></span>
                            </div>

                            <!-- Supporting Documents -->
                            <div class="mb-3">
                                <label class="form-label">Supporting Documents</label>
                                <input type="file"
                                       name="Documents"
                                       class="form-control"
                                       multiple
                                       accept=".pdf,.docx,.xlsx"
                                       id="fileInput">
                                <small class="form-text text-muted">
                                    Upload timesheets, schedules, or other supporting documents (PDF, Word, Excel only - Max 5MB each)
                                </small>
                                <div id="fileList" class="mt-2"></div>
                            </div>

                            <!-- Submit Buttons -->
                            <div class="d-flex justify-content-between">
                                <a asp-action="Index" class="btn btn-secondary">
                                    <i class="bi bi-arrow-left"></i> Cancel
                                </a>
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="bi bi-check-circle"></i> Submit Claim
                                </button>
                            </div>
                        </form>
                    }
                </div>
            </div>

            <!-- Info Card -->
            @if (assignments.Any())
            {
                <div class="card mt-3">
                    <div class="card-body">
                        <h6 class="card-title">Important Information</h6>
                        <ul class="small mb-0">
                            <li>Select the module you taught to automatically load the correct hourly rate</li>
                            <li>Your hourly rates are set by HR and cannot be modified</li>
                            <li>Provide accurate hours worked - this will be verified</li>
                            <li>Upload supporting documents to speed up approval</li>
                        </ul>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const moduleSelect = document.getElementById('moduleSelect');
        const hoursInput = document.getElementById('hoursInput');
        const rateInput = document.getElementById('rateInput');
        const totalInput = document.getElementById('totalAmount');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');

        // Update rate when module is selected
        moduleSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const rate = selectedOption.getAttribute('data-rate');

            if (rate) {
                rateInput.value = rate;
                calculateTotal();
            } else {
                rateInput.value = '';
                totalInput.value = '';
            }
        });

        // Calculate total when hours change
        hoursInput.addEventListener('input', calculateTotal);

        function calculateTotal() {
            const hours = parseFloat(hoursInput.value) || 0;
            const rate = parseFloat(rateInput.value) || 0;
            const total = hours * rate;

            if (total > 0) {
                totalInput.value = `R ${total.toFixed(2)}`;
            } else {
                totalInput.value = '';
            }
        }

        // File upload preview
        fileInput.addEventListener('change', function() {
            fileList.innerHTML = '';

            if (this.files.length > 0) {
                const ul = document.createElement('ul');
                ul.className = 'list-group';

                Array.from(this.files).forEach(file => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center';

                    const fileSize = (file.size / 1024 / 1024).toFixed(2);
                    const sizeClass = fileSize > 5 ? 'text-danger' : 'text-success';

                    li.innerHTML = `
                        <span><i class="bi bi-file-earmark"></i> ${file.name}</span>
                        <span class="badge ${sizeClass}">${fileSize} MB</span>
                    `;

                    ul.appendChild(li);
                });

                fileList.appendChild(ul);
            }
        });
    });
</script>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}